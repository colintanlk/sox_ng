From 8c2be5c74c6d10b1470812a8c9d0db88a595cc8b Mon Sep 17 00:00:00 2001
From: Mans Rullgard <mans@mansr.com>
Date: Fri, 27 Apr 2018 18:49:42 +0100
Subject: [PATCH] wav: adpcm: stricter header validation [bug #265]

If the samples per block and block align values do not match, the
file is invalid and decoding will likely fail.  Abort in this case
rather than returning garbage or crashing later.
---
 src/wav.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/wav.c b/src/wav.c
index 066be6d7..072a0cb3 100644
--- a/src/wav.c
+++ b/src/wav.c
@@ -766,7 +766,7 @@ static int startread(sox_format_t * ft)
 
         lsx_readw(ft, &(wav->samplesPerBlock));
         bytesPerBlock = lsx_ms_adpcm_bytes_per_block((size_t) ft->signal.channels, (size_t) wav->samplesPerBlock);
-        if (bytesPerBlock > wav->blockAlign)
+        if (bytesPerBlock != wav->blockAlign)
         {
             lsx_fail_errno(ft,SOX_EOF,"format[%s]: samplesPerBlock(%d) incompatible with blockAlign(%d)",
                 wav_format_str(wav->formatTag), wav->samplesPerBlock, wav->blockAlign);
@@ -823,7 +823,7 @@ static int startread(sox_format_t * ft)
 
         lsx_readw(ft, &(wav->samplesPerBlock));
         bytesPerBlock = lsx_ima_bytes_per_block((size_t) ft->signal.channels, (size_t) wav->samplesPerBlock);
-        if (bytesPerBlock > wav->blockAlign || wav->samplesPerBlock%8 != 1)
+        if (bytesPerBlock != wav->blockAlign || wav->samplesPerBlock%8 != 1)
         {
             lsx_fail_errno(ft,SOX_EOF,"format[%s]: samplesPerBlock(%d) incompatible with blockAlign(%d)",
                 wav_format_str(wav->formatTag), wav->samplesPerBlock, wav->blockAlign);
-- 
2.39.2

